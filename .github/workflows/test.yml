name: API Tests with Newman

on:
  push:
    branches:
      - main

jobs:
  vpn_job:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        
      - name: Install Newman (Postman CLI) & HTML Reporter
        run: npm install -g newman newman-reporter-html
        
      - name: Install OpenConnect
        run: sudo apt-get update && sudo apt-get install -y openconnect

      - name: Connect to GlobalProtect VPN
        run: |
          echo "${{ secrets.VPN_PASSWORD }}" | sudo openconnect --protocol=gp ${{ secrets.VPN_SERVER }} \
            --user=${{ secrets.VPN_USERNAME }} --passwd-on-stdin --background

      - name: Wait for VPN Connection
        run: sleep 10

      - name: Verify VPN Connection
        run: curl -s ifconfig.me

      - name: Access Target Host
        run: curl -k https://mobileap-uat.aboitizpower.com
        
      - name: Run API Tests
        run: newman run "QA TESTING Payment Channel Routes(Complete flow).postman_collection.json" -e "UAT SO.postman_environment.json" --iteration-data "ChannelRouteSampleData.json" --suppress-exit-code --reporters cli,junit,html --reporter-junit-export docs/report_PChannelRoute.xml --reporter-html-export docs/report_PChannelRoute.html || echo "Ignoring Newman errors"
      
      - name: Upload API Test Report
        uses: actions/upload-artifact@v4
        with:
          name: api-test-report
          path: docs/report_PChannelRoute.xml

      - name: Upload API Test HMTL Report
        uses: actions/upload-artifact@v4
        with:
          name: api-test-report
          path: docs/report_PChannelRoute.html

      - name: Commit & Push Report to Main
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add docs/
          git commit -m "Update API Test Report" || echo "No changes to commit"
          git push
